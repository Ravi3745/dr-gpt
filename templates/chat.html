<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dr-GPT Chat</title>

    <!-- Bootstrap (CDN) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Your CSS -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>

  <body class="app-bg">
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8 col-xl-6">
          <div class="chat-card shadow-lg">
            <!-- Header -->
            <div class="chat-header">
              <div class="d-flex align-items-center gap-3">
                <div class="chat-avatar">Dr</div>
                <div>
                  <div class="chat-title">Dr-GPT</div>
                  <div class="chat-subtitle">Medical Q&A (context-based)</div>
                </div>
              </div>

              <div class="status-pill">
                <span class="dot"></span>
                Online
              </div>
            </div>

            <!-- Messages -->
            <div id="chatBody" class="chat-body">
              <!-- Bot welcome -->
              <div class="msg-row bot">
                <div class="bubble">
                  Hi ðŸ‘‹ Iâ€™m here to help. What would you like to know?
                </div>
              </div>
            </div>

            <!-- Input -->
            <form id="chatForm" class="chat-input">
              <input
                id="messageInput"
                type="text"
                class="form-control"
                placeholder="Type your question..."
                autocomplete="off"
              />

              <div class="chat-actions">
                <button id="sendBtn" class="btn btn-send" type="submit">
                  Send
                </button>

                <button id="resetBtn" class="btn btn-reset" type="button">
                  New Chat
                </button>
              </div>
            </form>
          </div>

          <div class="text-center text-muted small mt-3">
            Tip: Ask short, specific questions for best results.
          </div>
        </div>
      </div>
    </div>

    <script>
      const chatBody = document.getElementById("chatBody");
      const chatForm = document.getElementById("chatForm");
      const messageInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const resetBtn = document.getElementById("resetBtn");

      let currentAbortController = null;
      let currentTypingRow = null;

      function scrollToBottom() {
        chatBody.scrollTop = chatBody.scrollHeight;
      }

      function addMessage(text, who = "user") {
        const row = document.createElement("div");
        row.className = `msg-row ${who}`;

        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.textContent = text;

        row.appendChild(bubble);
        chatBody.appendChild(row);
        scrollToBottom();

        return row;
      }

      function setSending(isSending) {
        sendBtn.disabled = isSending;
        messageInput.disabled = isSending;
        resetBtn.disabled = isSending; // âœ… prevents reset while sending (optional)
      }

      function resetUI() {
        // Remove typing indicator if present
        if (currentTypingRow) {
          currentTypingRow.remove();
          currentTypingRow = null;
        }

        // Clear chat + restore welcome
        chatBody.innerHTML = `
      <div class="msg-row bot">
        <div class="bubble">Hi ðŸ‘‹ Iâ€™m here to help. What would you like to know?</div>
      </div>
    `;
        scrollToBottom();

        // Allow typing again
        setSending(false);
        messageInput.value = "";
        messageInput.focus();
      }

      chatForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (!message) return;

        // Cancel any previous request
        if (currentAbortController) {
          currentAbortController.abort();
        }
        currentAbortController = new AbortController();

        addMessage(message, "user");
        messageInput.value = "";
        messageInput.focus();

        // typing indicator
        currentTypingRow = addMessage("Typingâ€¦", "bot");
        currentTypingRow.classList.add("typing");

        setSending(true);

        try {
          const res = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message }),
            signal: currentAbortController.signal,
          });

          const data = await res.json();

          // If request was aborted, do nothing
          if (currentAbortController.signal.aborted) return;

          // remove typing
          if (currentTypingRow) {
            currentTypingRow.remove();
            currentTypingRow = null;
          }

          addMessage(data.answer || "No answer received.", "bot");
        } catch (err) {
          // If aborted, silently ignore
          if (err.name === "AbortError") return;

          if (currentTypingRow) {
            currentTypingRow.remove();
            currentTypingRow = null;
          }
          addMessage("Server error. Please try again.", "bot");
        } finally {
          // Only re-enable if this request wasn't aborted by reset
          if (!currentAbortController?.signal.aborted) {
            setSending(false);
          }
        }
      });

      // Enter to send (single-line input)
      messageInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          chatForm.requestSubmit();
        }
      });

      resetBtn.addEventListener("click", async () => {
        // Abort in-flight request so no late response is appended
        if (currentAbortController) {
          currentAbortController.abort();
          currentAbortController = null;
        }

        // Reset server-side memory (ignore errors)
        try {
          await fetch("/reset", { method: "POST" });
        } catch (_) {}

        resetUI();
      });

      scrollToBottom();
    </script>
  </body>
</html>
